name: 'Create ROBOT diffs on Pull requests'

on:
  # Triggers the workflow on pull request events for the master branch
  pull_request:
    branches: [ master ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  create_diff_file:
    runs-on: ubuntu-latest
    container: obolibrary/odklite:v1.3.0
    steps:
      # Copy the relevant files from master branch (checking out whole branch takes very long)
      # The ontology obo file path will be: src/ontology/fypo-edit.owl
      - uses: Bhacaz/checkout-files@v2
        with:
          files: src/ontology/fypo-edit.yml fypo.owl
      - name: Move master files to master folder
        run: mkdir master; mv src/ontology/fypo-edit.yml fypo.owl master
      # Copy the relevant files from this branch
      - uses: Bhacaz/checkout-files@v2
        with:
          files: src/ontology/fypo-edit.yml fypo.owl
          branch: ${{ github.head_ref}}
      - name: Move branch files to branch folder
        run: mkdir branch; mv src/ontology/fypo-edit.yml fypo.owl branch
      - name: Run robot diff
        # -Xmx6G extension is to set 6gb of memory for java virtual machine
        # The second line produces the difference in the edit files only
        # The third line produces the difference after reasoner
        # To edit the second and third line for another ontology, test the robot code locally, and edit accordingly.
        # For example, FYPO does not need an extra --right-catalog but other ontologies may need it
        # See https://github.com/obophenotype/cell-ontology/blob/master/.github/workflows/diff.yml
        run: >
          export ROBOT_JAVA_ARGS=-Xmx6G;
          robot diff --labels True --left master/fypo-edit.owl --right branch/fypo-edit.owl -f markdown -o edit-diff.md;
          robot diff --labels True --left master/fypo.owl --right branch/fypo.owl -f markdown -o reasoned-diff.md;
      - name: Format comment
        # Create a comment where the diffs can be folded, so it does not take so much space
        run: >
            printf "# Changes added to the edit file this PR\n" > comment.md;
            printf "<details>\n<summary>Click to expand</summary>\n\n" >> comment.md;
            cat edit-diff.md >> comment.md;
            printf "\n</details\n\n>" >> comment.md;
            printf "# Changes to ontology after reasoner runs in this PR\n" >> comment.md;
            printf "<details>\n<summary>Click to expand</summary>\n\n" >> comment.md;
            cat reasoned-diff.md >> comment.md;
            printf "\n</details>\n\n" >> comment.md;
      - name: Post comment in the PR
        # Note how the path to comment.md needs ../../ in the path.
        env:
            GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
        uses: NejcZdovc/comment-pr@v1.1.1
        with:
          file: "../../comment.md"
          identifier: "HELLO"
